name: Shared Unit/Lint Workflow

on:
  workflow_call:
    inputs:
      language:
        required: true
        type: string
      working_directory:
        required: true
        type: string
      artifact_name:
        required: true
        type: string
      coverage_threshold:
        required: false
        type: number
        default: 80

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Download build artifact if it exists
      - name: Download build artifact
        id: download-artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ./build

      - name: Display artifact contents
        run: |
          echo "Artifact directory structure:"
          ls -R ./build || echo "No build directory found"

      # Select whether to use artifact or source
      - name: Prepare working directory
        id: select-dir
        run: |
          echo "Selecting directory for testing..."
          if [ -d "./build" ] && [ "$(ls -A ./build)" ]; then
            echo "Build artifact found — but will use source directory for lint/unit tests"
            echo "test_dir=${{ inputs.working_directory }}" >> $GITHUB_OUTPUT
          else
            echo "No build artifact found — using source directory"
            echo "test_dir=${{ inputs.working_directory }}" >> $GITHUB_OUTPUT
          fi

      - name: Show selected test directory
        run: |
          echo "Selected test directory: ${{ steps.select-dir.outputs.test_dir }}"
          ls -R "${{ steps.select-dir.outputs.test_dir }}" || true

      # # NodeJS
      # - name: Set up Node.js
      #   if: ${{ inputs.language == 'nodejs' }}
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: 20

      # - name: Lint & Test (NodeJS)
      #   if: ${{ inputs.language == 'nodejs' }}
      #   run: |
      #     cd "${{ steps.select-dir.outputs.test_dir }}"
      #     if [ -f "package.json" ]; then
      #       echo "Running npm install/lint/test..."
      #       npm ci || npm install
      #       npm run lint || echo "No lint script found"
      #       npm test || echo "No test script found"
      #     else
      #       echo "package.json not found — skipping NodeJS lint/test"
      #     fi

      # # Python
      # - name: Set up Python
      #   if: ${{ inputs.language == 'python' }}
      #   uses: actions/setup-python@v5
      #   with:
      #     python-version: "3.12"

      # - name: Lint & Test (Python)
      #   if: ${{ inputs.language == 'python' }}
      #   run: |
      #     echo "Running Python lint and unit tests..."
      #     cd "${{ steps.select-dir.outputs.test_dir }}"

      #     if [ -f "requirements.txt" ]; then
      #       echo "Installing dependencies..."
      #       python -m pip install --upgrade pip
      #       python -m pip install -r requirements.txt flake8 pytest coverage pytest-cov

      #       echo "Running flake8 lint..."
      #       flake8 . || true

      #       echo "Running pytest..."
      #       export PYTHONPATH="${PWD}/src"
      #       pytest -q --maxfail=1 --junitxml=test-results.xml --cov=. --cov-report=term-missing || true
      #     else
      #       echo "requirements.txt not found — skipping Python lint/test"
      #     fi

      # .NET
      - name: Set up .NET
        if: ${{ inputs.language == 'dotnet' }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Lint & Test (.NET)
        if: ${{ inputs.language == 'dotnet' }}
        run: |
          echo "Running .NET lint and unit tests..."
          cd "${{ inputs.working_directory }}"

          echo "Restoring dependencies for all projects..."
          for proj in $(find . -name "*.csproj"); do
            echo "Restoring $proj"
            dotnet restore "$proj"
          done

          # Run lint (dotnet format)
          echo "Running dotnet format lint..."
          dotnet format --verify-no-changes || echo "Lint issues found (non-blocking)."

          # Run tests with coverage
          echo "Running unit tests with coverage..."
          TEST_PROJECT=$(find . -name "*.Tests.csproj" | head -n 1)
          if [ -z "$TEST_PROJECT" ]; then
            echo "No test project (*.Tests.csproj) found — skipping tests."
            exit 1
          fi

          dotnet test "$TEST_PROJECT" \
            --no-build \
            --logger "trx;LogFileName=test_results.trx" \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=cobertura \
            /p:Threshold=${{ inputs.coverage_threshold }}

          echo ".NET lint/unit tests completed. Reports are in TestResults/ or coverage files in project folder."

      # Set up Java
      - name: Set up Java
        if: ${{ inputs.language == 'java' }}
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Lint & Test (Java)
        if: ${{ inputs.language == 'java' }}
        run: |
          echo "Running Checkstyle lint, unit tests, and coverage..."
      
          cd "${{ inputs.working_directory }}"
      
          # Run lint only (Checkstyle)
          echo "Running Checkstyle lint..."
          mvn checkstyle:checkstyle
      
          # Run unit tests with coverage (JaCoCo)
          echo "Running unit tests and coverage..."
          mvn clean test jacoco:report
      
          echo "Java lint/unit tests completed. Reports are in target/site/"

